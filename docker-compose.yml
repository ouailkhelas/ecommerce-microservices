services:

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    restart: unless-stopped

  # =============================================
  # GRAFANA - Visualisation des m√©triques
  # =============================================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    restart: unless-stopped

  auth-service:
    build: ./auth-service
    expose:
      - "3007"
    environment:
      - PGHOST=auth-db
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=password
      - PGDATABASE=auth_db
      - JWT_SECRET=your-super-secret-jwt-key-change-in-production-2024
      - JWT_EXPIRES_IN=1h
      - REFRESH_TOKEN_EXPIRES_IN=7d
      - PORT=3007
    depends_on:
      - auth-db

  auth-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=auth_db
    expose:
      - "5432"
    volumes:
      - auth_data:/var/lib/postgresql/data
      - ./auth-service/init-sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  api-gateway:
    image: nginx:alpine
    container_name: api-gateway
    ports:
      - "8080:8080"
    volumes:
      - ./api-gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./api-gateway/logs:/var/log/nginx
      - nginx_cache:/var/cache/nginx
    depends_on:
      - customer-service
      - order-service
      - inventory-service
      - payment-service
      - notification-service
      - shipping-service
      - auth-service

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    expose:
      - "5672"
      - "15672"
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: pass
    healthcheck:
      test: [ "CMD", "rabbitmqctl", "status" ]
      interval: 10s
      timeout: 5s
      retries: 5

  order-service:
    build: ./order-service
    expose:
      - "3001"
    environment:
      - PGHOST=order-db
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=password
      - PGDATABASE=order_db
    depends_on:
      - order-db
      - customer-service
      - inventory-service
      - payment-service

  order-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=order_db
    ports:
      - "54321:5432"
    volumes:
      - order_data:/var/lib/postgresql/data
      - ./order-service/init-sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  inventory-service:
    build: ./inventory-service
    expose:
      - "3002"
    environment:
      - PGHOST=inventory-db
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=password
      - PGDATABASE=inventory_db
    depends_on:
      - inventory-db

  inventory-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=inventory_db
    expose:
      - "54322"
    volumes:
      - inventory_data:/var/lib/postgresql/data
      - ./inventory-service/init-sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  customer-service:
    build: ./customer-service
    expose:
      - "3003"
    environment:
      - PGHOST=customer-db
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=password
      - PGDATABASE=customer_db
    depends_on:
      - customer-db

  customer-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=customer_db
    expose:
      - "54323"
    volumes:
      - customer_data:/var/lib/postgresql/data
      - ./customer-service/init-sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  payment-service:
    build: ./payment-service
    expose:
      - "3004"
    environment:
      - PGHOST=payment-db
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=password
      - PGDATABASE=payment_db
    depends_on:
      - payment-db
      - shipping-service
      - notification-service

  payment-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=payment_db
    expose:
      - "54324"
    volumes:
      - payment_data:/var/lib/postgresql/data
      - ./payment-service/init-sql/init.sql:/docker-entrypoint-initdb.d/init.sql

  shipping-service:
    build: ./shipping-service
    expose:
      - "3005"
    environment:
      - PGHOST=shipping-db
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=password
      - PGDATABASE=shipping_db
    depends_on:
      - shipping-db
      - notification-service

  shipping-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=shipping_db
    expose:
      - "54325"
    volumes:
      - shipping_data:/var/lib/postgresql/data
      - ./shipping-service/init-sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    # SUPPRIMER LA SECTION HEALTHCHECK

  notification-service:
    build: ./notification-service
    expose:
      - "3006"
    environment:
      - PGHOST=notification-db
      - PGPORT=5432
      - PGUSER=postgres
      - PGPASSWORD=password
      - PGDATABASE=notification_db
    depends_on:
      notification-db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  notification-db:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=notification_db
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5
    expose:
      - "54326"
    volumes:
      - notification_data:/var/lib/postgresql/data
      - ./notification-service/init-sql/init.sql:/docker-entrypoint-initdb.d/init.sql

volumes:
  auth_data:
  nginx_cache:
  order_data:
  inventory_data:
  customer_data:
  payment_data:
  shipping_data:
  notification_data:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
